IconKu.UI.Paging=new Class({Extends:IconKu.UI.Base,options:{size:10,index:1,wing:3,padding:1,ajax:true,"class":"",template:{pattern:"共{pages}页，当前第{index}页&nbsp;{numeric}{select}{go}",first:"首页",last:"尾页",go:"确定",prev:"上一页",next:"下一页",url:"#{index}"},data:{url:"",page:"p",size:"s"},method:"get",auto:true,wait:true,loadData:false,isSuccess:false,getDataCount:false,onBind:$empty,onLoading:$empty},initialize:function(a,b){this.containers=a;this.parent(b)},build:function(){var a=this.options;this.size=a.size||10;delete a.size;this.index=a.index||1;delete a.index;this.wing=a.wing||3;delete a.wing;this.padding=a.padding||1;delete a.padding;a.method=(a.method||"get").toLowerCase();a.data.url=$lambda(a.data.url);this.isSuccess=a.isSuccess||this.isSuccess;this.loadData=a.loadData||this.loadData;this.getDataCount=a.getDataCount||this.getDataCount;this.containers=$$(this.containers)||new Element("div",{"class":a["class"]});if(a["class"]){this.containers.addClass(a["class"])}this.bound={change:this.onChange.bindWithEvent(this),keydown:this.onKeydown.bindWithEvent(this),bind:this.onBind.bind(this),error:this.onError.bind(this)};this.attach();if(a.ajax&&a.auto){this.load(this.index)}},attach:function(){this.containers.addEvents({click:this.bound.change,keydown:this.bound.keydown})},inject:function(a,b){this.containers.inject(a,b)},get:function(b){var a=this.options,c="#page"+b;if(!a.ajax){c=a.template.url.substitute({index:b})}return'<a href="'+c+'">'+b+"</a>"},getNumeric:function(){var j=this.options,c=this,g=this.pages,f=[];if(g>1){var d=1,a=g;if(this.wing*2+1<g){a=this.wing*2+1;if(this.index>this.wing+1){if(this.index+this.wing>g){d=g-this.wing*2;a=g}else{d=this.index-this.wing;a=this.index+this.wing}}}if(this.index>1){f.push('<a href="#" class="prev">'+j.template.prev+"</a>")}this.padding.times(function(k){k=k+1;if(k<d){f.push(c.get(k))}});if(d>this.padding+2){f.push("..")}if(d==this.padding+2){f.push(this.get(this.padding+1))}var e=this.index;for(var b=d;b<=a;b++){f.push(e!=b?this.get(b):("<span>"+b+"</span>"))}var h=g-this.padding;if(a<h-1){f.push("..")}if(a==h-1){f.push(this.get(h))}this.padding.times(function(k){k=h+k+1;if(k>a){f.push(c.get(k))}});if(this.index<g){f.push('<a href="#" class="next">'+j.template.next+"</a>")}return f.join("")}else{return""}},getJump:function(a){return'<a href="#" class="'+a+'">'+this.options.template[a]+"</a>"},getSelect:function(){var a=['<select class="index">'];for(var b=1;b<=this.pages;b++){a.push('<option value="'+b+'">'+b+"</option>")}a[this.index]='<option value="'+this.index+'" selected="selected">'+this.index+"</option>";a.push("</select>");return a.join("")},getInput:function(){return'<input type="input" class="index" value="'+this.index+'" />'},getGo:function(){return'<a href="#" class="go">'+this.options.template.go+"</a>"},render:function(e,h,a){this.index=h||this.index;this.size=a||this.size;var i=this.options,c=this,f=this.pages=Math.ceil(e/this.size),d=i.template,b=d.pattern,g={};if(f>1){g.index=this.index;g.pages=f;g.total=e;g.from=(this.index-1)*this.size+1;g.to=Math.min(g.from+this.size-1,e);b=b.replace(/\{([^}]+?)\}/g,function(k,j){j=j.toLowerCase();switch(j){case"from":case"to":case"index":case"pages":case"total":return g[j];case"prev":case"first":case"last":case"next":return c.getJump(j);case"select":case"input":case"go":case"numeric":return c["get"+j.capitalize()]()}});this.containers.set("html",b).show()}else{this.containers.set("text","").hide()}},load:function(b){var a=this.options,c={};this.index=b||1;c[a.data.page]=this.index;c[a.data.size]=this.size;if(a.method!="post"){c.rd=$time()}this.fireEvent("beforeLoad",c);this.loadData.call(this,c)},loadData:function(b){var a=this.options;if(!this.xhr){this.xhr=new Request.JSON({method:a.method,url:a.data.url(this.index),link:"cancel",onComplete:this.bound.bind,onFailure:this.bound.error})}try{this.xhr.send({data:b});this.fireEvent("loading",this)}catch(c){this.fireEvent("error",c.message)}},getNode:function(a,b){return a.tagName==b?a:$(a).getParents(b)[0]},onError:function(a){this.render(0);this.fireEvent("error",[a])},isSuccess:function(a){return a&&a.status==1},getDataCount:function(a){return a.data.count},onBind:function(a){if(this.isSuccess.call(this,a)){this.render(this.getDataCount.call(this,a));this.fireEvent("bind",[a,this])}},onChange:function(f){var g=this.getNode(f.target,"A"),a=this.options.ajax;if(g){var d=this.index;switch(g.className){case"prev":if(this.index>1){d=this.index-1}break;case"next":if(this.index<this.pages){d=this.index+1}break;case"first":d=1;break;case"last":d=this.pages;break;case"go":g=f.target;while(!this.containers.contains(g=g.parentNode)){}var c=this;g=g.getElements(".index").filter(function(e){v=e.value;return v&&v!=c.index&&v>=1&&v<=c.pages})[0];if(g){d=parseInt(g.value,10)}break;default:var b=parseInt(f.target.innerHTML)|0;if(0<b&&b<=this.pages){d=b}if(a){return}break}if(!a){location=this.options.template.url.substitute({index:d})}f&&f.preventDefault();if(d!=this.index){this.load(d)}}},onKeydown:function(c){var b=c.target;if(b&&(b.tagName=="INPUT"||b.tagName=="SELECT")){var a=parseInt(b.value,10);if(a!=this.index&&a>0&&a<=this.pages){this.load(a)}}}});